---
description: Active Directory Privilege Escalation
---

# Active Directory

## **Group Managed Service Accounts (gMSA)**

{% embed url="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Active%20Directory%20Attack.md#reading-gmsa-password" %}

User accounts created to be used as service accounts rarely have their password changed. Group Managed Service Accounts (GMSAs) provide a better approach (starting in the Windows 2012 timeframe). The password is managed by AD and automatically changed.

If you have access to a user account who has permissions to read the managed password, then you can do so like this:

**WARNING: gMSADumper.py gets the password HASH**. You can also get the actual password though, I think, using other tools.

```
# https://github.com/micahvandeusen/gMSADumper
python3 gMSADumper.py -u User -p Password1 -d domain.local
```

You can also use a **hash** instead of a password with gMSADumper.

If you're not sure whether you can read managed passwords, then the attribute you need to look for in Ad is **msDS-GroupMSAMembership (PrincipalsAllowedToRetrieveManagedPassword)**. It stores the security principals that can access the GMSA password.



**TrustedToAuthForDelegation**

{% embed url="https://www.harmj0y.net/blog/activedirectory/s4u2pwnage/" %}

If an AD user has the **TRUSTED\_TO\_AUTH\_FOR\_DELEGATION** (constrained delegation) or **ADS\_UF\_TRUSTED\_FOR\_DELEGATION** (unconstrained delegation) field set in their userAccountControl, then they can request tickets on behalf of other users, without knowing their password.&#x20;

* **Unconstrained** - you can request a ticket for any service as any user that doesn't have ‘Account is sensitive and cannot be delegated’ enabled.
  * If a user cannot be delegated, then it has **NOT\_DELEGATED** in its userAccountControl attribute
* **Constrained** - you can request a ticket for a specific service as any user that doesn't have ‘Account is sensitive and cannot be delegated’ enabled.
  * Specifically, you can request a service ticket to any SPN specified in msds-allowedtodelegateto.

### **Enumeration**

You could use PowerView’s **-TrustedToAuth** flag for **Get-DomainUser/Get-DomainComputer**. Look at [harmj0y's post](https://www.harmj0y.net/blog/activedirectory/s4u2pwnage/) to see the full command.

Alternatively, if you dumped the active directory with something like [ldapdomaindump](https://github.com/dirkjanm/ldapdomaindump), then you might also notice the **TRUSTED\_TO\_AUTH\_FOR\_DELEGATION** or **ADS\_UF\_TRUSTED\_FOR\_DELEGATION** flags.

### **Exploitation**

Sources:

* Exploit using [Windows-based tools](https://www.harmj0y.net/blog/activedirectory/s4u2pwnage/)
* Exploit using [Linux-based tools](https://labs.f-secure.com/archive/trust-years-to-earn-seconds-to-break/)

